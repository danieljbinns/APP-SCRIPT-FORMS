<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <title>New Employee Request</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <?!= include('Shared/CSS'); ?>
  </head>
  <body>
    <?!= include('Shared/Header'); ?>
    
    <div class="container">
      <h1>New Employee Request</h1>
      <p>Please complete all required fields to submit a new employee request.</p>
      
      <form id="request-form" onsubmit="handleSubmit(event)">
        <!-- Hidden field for form type -->
        <input type="hidden" name="formType" value="initial">
        
        <!-- Gatekeeper Question -->
        <div class="form-section">
          <h2>Pre-Submission Checklist</h2>
          
          <div class="question-wrapper">
            <label for="gatekeeper">Have all Recruiting Requirements been met? *</label>
            <select id="gatekeeper" name="gatekeeper" required onchange="toggleMainForm()">
              <option value="">-- Please Select --</option>
              <option value="Yes">Yes</option>
              <option value="No">No</option>
            </select>
          </div>
          
          <div id="gatekeeper-message" class="status-error" style="display: none;">
            All Recruiting Requirements must be met before proceeding. Please contact HR.
          </div>
        </div>
        
        <!-- Main Form (hidden until gatekeeper = Yes) -->
        <div id="main-form" style="display: none;">
          
          <!-- Requester Information -->
          <div class="form-section">
            <h2>Requester Information</h2>
            
            <div class="question-wrapper">
              <label for="requester-name">Your Name *</label>
              <input type="text" id="requester-name" name="Requester Name" required>
            </div>
            
            <div class="question-wrapper">
              <label for="requester-email">Your Email *</label>
              <input type="email" id="requester-email" name="Requester Email" required>
            </div>
            
            <div class="question-wrapper">
              <label for="requester-phone">Your Phone Number</label>
              <input type="tel" id="requester-phone" name="Requester Phone">
            </div>
          </div>
          
          <!-- New Employee Information -->
          <div class="form-section">
            <h2>New Employee Information</h2>            
            <div class="question-wrapper">
              <label for="first-name">First Name *</label>
              <input type="text" id="first-name" name="First Name" required>
            </div>
            
            <div class="question-wrapper">
              <label for="last-name">Last Name *</label>
              <input type="text" id="last-name" name="Last Name" required>
            </div>
            
            <div class="question-wrapper">
              <label for="hire-date">Hire Date *</label>
              <input type="date" id="hire-date" name="Hire Date" required>
            </div>
            
            <div class="question-wrapper">
              <label for="site-name">Site Name *</label>
              <select id="site-name" name="Site Name" required onchange="syncJobNumber()">
                <option value="">-- Select Site --</option>
                <? jobCodes.forEach(function(row) { ?>
                  <option value="<?= row[0] ?>" data-job="<?= row[2] ?>"><?= row[0] ?></option>
                <? }); ?>
              </select>
            </div>
            
            <div class="question-wrapper">
              <label for="job-number">Job Number *</label>
              <select id="job-number" name="Job Number" required onchange="syncSiteName()">
                <option value="">-- Select Job Number --</option>
                <? jobCodes.forEach(function(row) { ?>
                  <option value="<?= row[2] ?>" data-site="<?= row[0] ?>"><?= row[2] ?></option>
                <? }); ?>
              </select>
            </div>            
            <div class="question-wrapper">
              <label for="department">Department *</label>
              <input type="text" id="department" name="Department" required>
            </div>
            
            <div class="question-wrapper">
              <label for="position">Position/Title *</label>
              <input type="text" id="position" name="Position/Title" required>
            </div>
            
            <div class="question-wrapper">
              <label for="hourly-salary">Hourly or Salary *</label>
              <select id="hourly-salary" name="Hourly or Salary" required onchange="updateAccessSection()">
                <option value="">-- Please Select --</option>
                <option value="Hourly">Hourly</option>
                <option value="Salary">Salary</option>
              </select>
            </div>
            
            <div class="question-wrapper">
              <label for="manager-email">Reporting Manager Email *</label>
              <input type="email" id="manager-email" name="Reporting Manager Email" required>
            </div>
          </div>
          
          <!-- Equipment & Access -->
          <div class="form-section">
            <h2>Equipment & Access Requests</h2>
            
            <div class="question-wrapper checkbox-wrapper">
              <input type="checkbox" id="laptop" name="Laptop" value="Yes">
              <label for="laptop">Laptop</label>
            </div>
            
            <div class="question-wrapper checkbox-wrapper">
              <input type="checkbox" id="monitor" name="Monitor" value="Yes">
              <label for="monitor">Monitor</label>
            </div>            
            <div class="question-wrapper checkbox-wrapper">
              <input type="checkbox" id="keyboard" name="Keyboard" value="Yes">
              <label for="keyboard">Keyboard</label>
            </div>
            
            <div class="question-wrapper checkbox-wrapper">
              <input type="checkbox" id="mouse" name="Mouse" value="Yes">
              <label for="mouse">Mouse</label>
            </div>
            
            <div class="question-wrapper checkbox-wrapper">
              <input type="checkbox" id="phone" name="Phone" value="Yes">
              <label for="phone">Phone</label>
            </div>
            
            <div class="question-wrapper checkbox-wrapper">
              <input type="checkbox" id="fleetio" name="Fleetio" value="Yes">
              <label for="fleetio">Vehicle/Fleetio Access</label>
            </div>
            
            <div class="question-wrapper checkbox-wrapper">
              <input type="checkbox" id="credit-card" name="Credit Card" value="Yes">
              <label for="credit-card">Credit Card</label>
            </div>
          </div>
          
          <!-- Submit Button -->
          <div class="submit-container">
            <button type="submit" class="submit-btn">Submit Request</button>
          </div>
        </div>
      </form>
      
      <div id="status-message"></div>
    </div>
    
    <?!= include('Shared/Footer'); ?>
    
    <script>
      // Gatekeeper logic
      function toggleMainForm() {
        const gatekeeper = document.getElementById('gatekeeper').value;
        const mainForm = document.getElementById('main-form');
        const message = document.getElementById('gatekeeper-message');
        
        if (gatekeeper === 'Yes') {
          mainForm.style.display = 'block';
          message.style.display = 'none';
        } else {
          mainForm.style.display = 'none';
          message.style.display = gatekeeper === 'No' ? 'block' : 'none';
        }
      }
      
      // Sync Site Name and Job Number dropdowns
      function syncJobNumber() {
        const siteSelect = document.getElementById('site-name');
        const jobSelect = document.getElementById('job-number');
        const selectedOption = siteSelect.options[siteSelect.selectedIndex];
        
        if (selectedOption.dataset.job) {
          jobSelect.value = selectedOption.dataset.job;
        }
      }
      
      function syncSiteName() {
        const jobSelect = document.getElementById('job-number');
        const siteSelect = document.getElementById('site-name');
        const selectedOption = jobSelect.options[jobSelect.selectedIndex];
        
        if (selectedOption.dataset.site) {
          siteSelect.value = selectedOption.dataset.site;
        }
      }
      
      // Update access section visibility based on hourly/salary
      function updateAccessSection() {
        const type = document.getElementById('hourly-salary').value;
        // Additional logic can be added here for conditional sections
      }
      
      // Form submission
      function handleSubmit(event) {
        event.preventDefault();
        
        const statusDiv = document.getElementById('status-message');
        statusDiv.textContent = 'Submitting...';
        statusDiv.className = 'status-info';
        
        const formData = new FormData(event.target);
        const data = {};
        
        // Convert FormData to object
        for (const [key, value] of formData.entries()) {
          data[key] = value;
        }
        
        // Handle checkboxes
        document.querySelectorAll('input[type="checkbox"]').forEach(cb => {
          data[cb.name] = cb.checked ? 'Yes' : 'No';
        });
        
        // Add timestamp and generate Request ID
        data['Submission Timestamp'] = new Date().toISOString();
        
        // Submit to server
        google.script.run
          .withSuccessHandler(function(response) {
            statusDiv.className = 'status-success';
            statusDiv.textContent = response.message;
            
            if (response.status === 'success') {
              document.getElementById('request-form').reset();
              document.getElementById('main-form').style.display = 'none';
            }
          })
          .withFailureHandler(function(error) {
            statusDiv.className = 'status-error';
            statusDiv.textContent = 'Error: ' + error.message;
          })
          .processInitialRequest(data);
      }
    </script>
  </body>
</html>