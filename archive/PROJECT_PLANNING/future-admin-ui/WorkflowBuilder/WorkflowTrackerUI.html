<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Workflow Tracker Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        background: #f5f5f5;
        color: #333;
        overflow-x: hidden;
      }

      .dashboard-container {
        max-width: 1600px;
        margin: 0 auto;
        padding: 20px;
      }

      /* Header */
      .header {
        background: white;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        display: flex;
        align-items: center;
        gap: 20px;
      }

      .header img.logo {
        height: 50px;
        width: auto;
      }

      .header-title {
        flex: 1;
      }

      .header h1 {
        font-size: 28px;
        color: #1a73e8;
        margin: 0;
      }

      .header p {
        color: #999;
        font-size: 14px;
        margin: 5px 0 0 0;
      }

      /* Filter Panel */
      .filter-panel {
        background: white;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }

      .filter-panel h3 {
        margin-bottom: 15px;
        font-size: 16px;
        color: #333;
      }

      .filter-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
      }

      .filter-group {
        display: flex;
        flex-direction: column;
      }

      .filter-group label {
        font-size: 12px;
        font-weight: 600;
        color: #666;
        margin-bottom: 5px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .filter-group input,
      .filter-group select {
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
        font-family: inherit;
      }

      .filter-group input:focus,
      .filter-group select:focus {
        outline: none;
        border-color: #1a73e8;
        box-shadow: 0 0 0 3px rgba(26, 115, 232, 0.1);
      }

      .filter-actions {
        display: flex;
        gap: 10px;
        margin-top: 15px;
      }

      button {
        padding: 10px 20px;
        border: none;
        border-radius: 4px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
      }

      .btn-primary {
        background: #1a73e8;
        color: white;
      }

      .btn-primary:hover {
        background: #1566c0;
        box-shadow: 0 2px 8px rgba(26, 115, 232, 0.3);
      }

      .btn-secondary {
        background: #f0f0f0;
        color: #333;
        border: 1px solid #ddd;
      }

      .btn-secondary:hover {
        background: #e8e8e8;
      }

      .btn-danger {
        background: #d32f2f;
        color: white;
      }

      .btn-danger:hover {
        background: #b71c1c;
      }

      .btn-warning {
        background: #f57c00;
        color: white;
      }

      .btn-warning:hover {
        background: #e64a19;
      }

      .btn-success {
        background: #388e3c;
        color: white;
      }

      .btn-success:hover {
        background: #2e7d32;
      }

      button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      /* KPI Cards */
      .kpi-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 20px;
      }

      .kpi-card {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }

      .kpi-card h4 {
        font-size: 12px;
        font-weight: 600;
        color: #999;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 10px;
      }

      .kpi-value {
        font-size: 32px;
        font-weight: 700;
        color: #1a73e8;
      }

      .kpi-subtitle {
        font-size: 12px;
        color: #999;
        margin-top: 8px;
      }

      /* Charts Section */
      .charts-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
        gap: 20px;
        margin-bottom: 20px;
      }

      .chart-card {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }

      .chart-card h3 {
        font-size: 16px;
        margin-bottom: 15px;
        color: #333;
      }

      .chart-container {
        position: relative;
        height: 300px;
      }

      /* Tracker Table */
      .tracker-section {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        overflow-x: auto;
      }

      .tracker-section h3 {
        font-size: 16px;
        margin-bottom: 15px;
        color: #333;
      }

      .tracker-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 13px;
      }

      .tracker-table thead {
        background: #f9f9f9;
        border-bottom: 2px solid #ddd;
      }

      .tracker-table th {
        padding: 12px;
        text-align: left;
        font-weight: 600;
        color: #333;
        white-space: nowrap;
      }

      .tracker-table td {
        padding: 12px;
        border-bottom: 1px solid #eee;
      }

      .tracker-table tbody tr:hover {
        background: #f9f9f9;
      }

      .status-badge {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
        white-space: nowrap;
      }

      .status-completed {
        background: #c8e6c9;
        color: #2e7d32;
      }

      .status-pending {
        background: #fff9c4;
        color: #f57f17;
      }

      .status-in-progress {
        background: #bbdefb;
        color: #1565c0;
      }

      .status-cancelled {
        background: #ffccbc;
        color: #d84315;
      }

      .status-delayed {
        background: #f8bbd0;
        color: #c2185b;
      }

      .action-buttons {
        display: flex;
        gap: 5px;
      }

      .action-buttons button {
        padding: 6px 10px;
        font-size: 12px;
        min-width: auto;
        white-space: nowrap;
      }

      /* Modal */
      .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.5);
        animation: fadeIn 0.3s;
      }

      .modal.show {
        display: flex;
        align-items: center;
        justify-content: center;
      }

      @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
      }

      .modal-content {
        background-color: white;
        padding: 30px;
        border-radius: 8px;
        max-width: 500px;
        width: 90%;
        box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        animation: slideIn 0.3s;
      }

      @keyframes slideIn {
        from {
          transform: translateY(-50px);
          opacity: 0;
        }
        to {
          transform: translateY(0);
          opacity: 1;
        }
      }

      .modal-header {
        font-size: 20px;
        font-weight: 600;
        margin-bottom: 20px;
        color: #333;
      }

      .modal-body {
        margin-bottom: 20px;
      }

      .modal-body p {
        margin-bottom: 15px;
        line-height: 1.6;
      }

      .modal-input-group {
        margin-bottom: 15px;
      }

      .modal-input-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: 600;
        color: #333;
      }

      .modal-input-group input,
      .modal-input-group textarea {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-family: inherit;
        font-size: 14px;
      }

      .modal-input-group textarea {
        resize: vertical;
        min-height: 80px;
      }

      .modal-footer {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
      }

      /* Spinner */
      .spinner {
        border: 3px solid rgba(26, 115, 232, 0.1);
        border-radius: 50%;
        border-top: 3px solid #1a73e8;
        width: 20px;
        height: 20px;
        animation: spin 0.8s linear infinite;
        display: inline-block;
        margin-left: 8px;
      }

      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }

      /* Status Message */
      .status-message {
        padding: 15px;
        border-radius: 4px;
        margin-bottom: 15px;
        display: none;
      }

      .status-message.show {
        display: block;
      }

      .status-success {
        background: #c8e6c9;
        color: #2e7d32;
        border-left: 4px solid #2e7d32;
      }

      .status-error {
        background: #ffccbc;
        color: #d84315;
        border-left: 4px solid #d84315;
      }

      /* No data */
      .no-data {
        text-align: center;
        padding: 40px;
        color: #999;
      }

      .no-data p {
        font-size: 16px;
        margin-bottom: 10px;
      }

      /* Responsive */
      @media (max-width: 1024px) {
        .filter-grid {
          grid-template-columns: repeat(2, 1fr);
        }

        .charts-grid {
          grid-template-columns: 1fr;
        }
      }

      @media (max-width: 600px) {
        .header {
          flex-direction: column;
          text-align: center;
        }

        .header-title {
          width: 100%;
        }

        .filter-grid {
          grid-template-columns: 1fr;
        }

        .kpi-grid {
          grid-template-columns: 1fr;
        }

        .filter-actions {
          flex-direction: column;
        }

        .filter-actions button {
          width: 100%;
        }
      }
    </style>
  </head>
  <body>

    <div class="dashboard-container">

      <!-- Header -->
      <div class="header">
        <img src="<?= logoUrl ?>" alt="<?= companyName ?>" class="logo">
        <div class="header-title">
          <h1>Workflow Tracker Dashboard</h1>
          <p>Track and manage all workflow instances across the organization</p>
        </div>
      </div>

      <!-- Status Message -->
      <div id="statusMessage" class="status-message"></div>

      <!-- Filter Panel -->
      <div class="filter-panel">
        <h3>Filters</h3>
        <div class="filter-grid">
          <div class="filter-group">
            <label for="filterWorkflow">Workflow Type</label>
            <select id="filterWorkflow">
              <? for (let i = 0; i < workflowTypes.length; i++) { ?>
                <option value="<?= workflowTypes[i] ?>"><?= workflowTypes[i] ?></option>
              <? } ?>
            </select>
          </div>

          <div class="filter-group">
            <label for="filterStatus">Status</label>
            <select id="filterStatus" multiple>
              <option value="Pending" selected>Pending</option>
              <option value="In Progress" selected>In Progress</option>
              <option value="Completed" selected>Completed</option>
              <option value="Cancelled">Cancelled</option>
              <option value="Delayed">Delayed</option>
            </select>
          </div>

          <div class="filter-group">
            <label for="filterSite">Site</label>
            <select id="filterSite">
              <option value="">-- All Sites --</option>
              <? for (let i = 0; i < sites.length; i++) { ?>
                <option value="<?= sites[i] ?>"><?= sites[i] ?></option>
              <? } ?>
            </select>
          </div>

          <div class="filter-group">
            <label for="filterRequestor">Requestor</label>
            <select id="filterRequestor">
              <option value="">-- All Requestors --</option>
              <? for (let i = 0; i < requestors.length; i++) { ?>
                <option value="<?= requestors[i] ?>"><?= requestors[i] ?></option>
              <? } ?>
            </select>
          </div>

          <div class="filter-group">
            <label for="filterEmployee">Employee Name</label>
            <input type="text" id="filterEmployee" placeholder="Search employee...">
          </div>

          <div class="filter-group">
            <label for="filterDateFrom">Date From</label>
            <input type="date" id="filterDateFrom">
          </div>

          <div class="filter-group">
            <label for="filterDateTo">Date To</label>
            <input type="date" id="filterDateTo">
          </div>
        </div>

        <div class="filter-actions">
          <button class="btn-primary" onclick="applyFilters()">Apply Filters</button>
          <button class="btn-secondary" onclick="resetFilters()">Reset</button>
          <button class="btn-secondary" onclick="exportData()">Export CSV</button>
        </div>
      </div>

      <!-- KPI Cards -->
      <div class="kpi-grid" id="kpiContainer">
        <!-- Populated by JavaScript -->
      </div>

      <!-- Charts -->
      <div class="charts-grid">
        <div class="chart-card">
          <h3>Status Distribution</h3>
          <div class="chart-container">
            <canvas id="statusChart"></canvas>
          </div>
        </div>

        <div class="chart-card">
          <h3>Days to Complete</h3>
          <div class="chart-container">
            <canvas id="daysChart"></canvas>
          </div>
        </div>

        <div class="chart-card">
          <h3>Requests by Site</h3>
          <div class="chart-container">
            <canvas id="siteChart"></canvas>
          </div>
        </div>

        <div class="chart-card">
          <h3>Requests Over Time</h3>
          <div class="chart-container">
            <canvas id="trendChart"></canvas>
          </div>
        </div>
      </div>

      <!-- Tracker Table -->
      <div class="tracker-section">
        <h3>Workflow Instances</h3>
        <div id="tableContainer">
          <!-- Populated by JavaScript -->
        </div>
      </div>

    </div>

    <!-- Modals -->

    <!-- Delay Modal -->
    <div id="delayModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">Delay Workflow</div>
        <div class="modal-body">
          <p>Delay this workflow instance to a future date. A notification will be sent when the new deadline approaches.</p>
          <div class="modal-input-group">
            <label for="delayUntil">New Deadline Date</label>
            <input type="date" id="delayUntil">
          </div>
          <div class="modal-input-group">
            <label for="delayReason">Reason for Delay</label>
            <textarea id="delayReason" placeholder="Explain why this workflow is being delayed..."></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn-secondary" onclick="closeModal('delayModal')">Cancel</button>
          <button class="btn-warning" onclick="confirmDelay()">Delay Workflow</button>
        </div>
      </div>
    </div>

    <!-- Cancel Modal -->
    <div id="cancelModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">Cancel Workflow</div>
        <div class="modal-body">
          <p>Are you sure you want to cancel this workflow instance? This action can be undone, but the workflow will not progress.</p>
          <div class="modal-input-group">
            <label for="cancelReason">Reason for Cancellation</label>
            <textarea id="cancelReason" placeholder="Explain why this workflow is being cancelled..."></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn-secondary" onclick="closeModal('cancelModal')">Keep Active</button>
          <button class="btn-danger" onclick="confirmCancel()">Yes, Cancel Workflow</button>
        </div>
      </div>
    </div>

    <!-- Edit Modal -->
    <div id="editModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">Edit & Resubmit Workflow</div>
        <div class="modal-body">
          <p>This will reopen the workflow form for editing and resubmission. Any previous responses will be preserved.</p>
          <div class="modal-input-group">
            <label for="editNotes">Notes for Revision</label>
            <textarea id="editNotes" placeholder="Add any notes about what needs to be revised..."></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn-secondary" onclick="closeModal('editModal')">Cancel</button>
          <button class="btn-success" onclick="confirmEdit()">Open for Editing</button>
        </div>
      </div>
    </div>

    <script>
      // Global variables
      let allTrackerData = <?!= JSON.stringify(trackerData) ?>;
      let currentFilters = {
        workflowType: 'All',
        status: ['Pending', 'In Progress', 'Completed'],
        site: '',
        requestor: '',
        employeeName: '',
        dateFrom: '',
        dateTo: ''
      };
      let currentRequestId = '';
      let currentWorkflowType = '';
      let statusChart = null;
      let daysChart = null;
      let siteChart = null;
      let trendChart = null;

      /**
       * Initialize dashboard on page load
       */
      window.addEventListener('DOMContentLoaded', function() {
        applyFilters();
      });

      /**
       * Apply filters and update dashboard
       */
      function applyFilters() {
        // Get filter values
        currentFilters.workflowType = document.getElementById('filterWorkflow').value;
        currentFilters.status = getSelectedOptions('filterStatus');
        currentFilters.site = document.getElementById('filterSite').value;
        currentFilters.requestor = document.getElementById('filterRequestor').value;
        currentFilters.employeeName = document.getElementById('filterEmployee').value;
        currentFilters.dateFrom = document.getElementById('filterDateFrom').value;
        currentFilters.dateTo = document.getElementById('filterDateTo').value;

        // Filter data
        const filteredData = filterTrackerData(currentFilters, allTrackerData);

        // Update display
        updateKPIs(filteredData);
        updateCharts(filteredData);
        updateTable(filteredData);
      }

      /**
       * Reset all filters
       */
      function resetFilters() {
        document.getElementById('filterWorkflow').value = 'All';
        document.getElementById('filterStatus').selectedIndex = 0;
        document.getElementById('filterSite').value = '';
        document.getElementById('filterRequestor').value = '';
        document.getElementById('filterEmployee').value = '';
        document.getElementById('filterDateFrom').value = '';
        document.getElementById('filterDateTo').value = '';
        applyFilters();
      }

      /**
       * Get selected values from multi-select
       */
      function getSelectedOptions(selectId) {
        const select = document.getElementById(selectId);
        const values = [];
        for (let i = 0; i < select.options.length; i++) {
          if (select.options[i].selected) {
            values.push(select.options[i].value);
          }
        }
        return values.length > 0 ? values : ['Pending', 'In Progress', 'Completed'];
      }

      /**
       * Filter tracker data based on current filters
       */
      function filterTrackerData(filters, trackerData) {
        return trackerData.filter(function(item) {
          if (filters.workflowType !== 'All' && item.workflowType !== filters.workflowType) return false;
          if (filters.status.length > 0 && filters.status.indexOf(item.status) === -1) return false;
          if (filters.site && item.site !== filters.site) return false;
          if (filters.requestor && item.requestorName !== filters.requestor) return false;
          if (filters.employeeName && item.employeeName.toLowerCase().indexOf(filters.employeeName.toLowerCase()) === -1) return false;
          if (filters.dateFrom && new Date(item.dateOpened) < new Date(filters.dateFrom)) return false;
          if (filters.dateTo && new Date(item.dateOpened) > new Date(filters.dateTo)) return false;
          return true;
        });
      }

      /**
       * Update KPI cards
       */
      function updateKPIs(filteredData) {
        const completed = filteredData.filter(item => item.status === 'Completed').length;
        const pending = filteredData.filter(item => item.status === 'Pending' || item.status === 'In Progress').length;
        const completionRate = filteredData.length > 0 ? ((completed / filteredData.length) * 100).toFixed(1) : 0;

        const daysToComplete = filteredData
          .filter(item => item.daysToComplete !== null)
          .map(item => item.daysToComplete);
        const avgDays = daysToComplete.length > 0 ? (daysToComplete.reduce((a, b) => a + b, 0) / daysToComplete.length).toFixed(1) : 'N/A';

        const kpiHTML = `
          <div class="kpi-card">
            <h4>Total Workflows</h4>
            <div class="kpi-value">${filteredData.length}</div>
            <div class="kpi-subtitle">Current filter results</div>
          </div>
          <div class="kpi-card">
            <h4>Completion Rate</h4>
            <div class="kpi-value">${completionRate}%</div>
            <div class="kpi-subtitle">${completed} of ${filteredData.length} completed</div>
          </div>
          <div class="kpi-card">
            <h4>Pending</h4>
            <div class="kpi-value">${pending}</div>
            <div class="kpi-subtitle">Awaiting action</div>
          </div>
          <div class="kpi-card">
            <h4>Avg Days to Complete</h4>
            <div class="kpi-value">${avgDays}</div>
            <div class="kpi-subtitle">Completed workflows only</div>
          </div>
        `;

        document.getElementById('kpiContainer').innerHTML = kpiHTML;
      }

      /**
       * Update charts
       */
      function updateCharts(filteredData) {
        // Status distribution pie chart
        updateStatusChart(filteredData);

        // Days to complete histogram
        updateDaysChart(filteredData);

        // Requests by site
        updateSiteChart(filteredData);

        // Trend over time
        updateTrendChart(filteredData);
      }

      function updateStatusChart(filteredData) {
        const statusCounts = {
          'Completed': 0,
          'Pending': 0,
          'In Progress': 0,
          'Cancelled': 0,
          'Delayed': 0
        };

        filteredData.forEach(item => {
          if (statusCounts.hasOwnProperty(item.status)) {
            statusCounts[item.status]++;
          }
        });

        const ctx = document.getElementById('statusChart').getContext('2d');
        if (statusChart) statusChart.destroy();
        statusChart = new Chart(ctx, {
          type: 'doughnut',
          data: {
            labels: Object.keys(statusCounts),
            datasets: [{
              data: Object.values(statusCounts),
              backgroundColor: [
                '#66bb6a',
                '#ffd54f',
                '#42a5f5',
                '#ef5350',
                '#ec407a'
              ]
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: 'bottom'
              }
            }
          }
        });
      }

      function updateDaysChart(filteredData) {
        const completedData = filteredData.filter(item => item.daysToComplete !== null);
        const daysBuckets = {};
        completedData.forEach(item => {
          const bucket = Math.floor(item.daysToComplete / 5) * 5;
          const label = bucket + '-' + (bucket + 5);
          daysBuckets[label] = (daysBuckets[label] || 0) + 1;
        });

        const ctx = document.getElementById('daysChart').getContext('2d');
        if (daysChart) daysChart.destroy();
        daysChart = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: Object.keys(daysBuckets).sort((a, b) => parseInt(a) - parseInt(b)),
            datasets: [{
              label: 'Number of Workflows',
              data: Object.values(daysBuckets),
              backgroundColor: '#42a5f5'
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: false
              }
            },
            scales: {
              y: {
                beginAtZero: true
              }
            }
          }
        });
      }

      function updateSiteChart(filteredData) {
        const siteCounts = {};
        filteredData.forEach(item => {
          siteCounts[item.site] = (siteCounts[item.site] || 0) + 1;
        });

        const ctx = document.getElementById('siteChart').getContext('2d');
        if (siteChart) siteChart.destroy();
        siteChart = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: Object.keys(siteCounts),
            datasets: [{
              label: 'Number of Workflows',
              data: Object.values(siteCounts),
              backgroundColor: '#66bb6a'
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: false
              }
            },
            scales: {
              y: {
                beginAtZero: true
              }
            }
          }
        });
      }

      function updateTrendChart(filteredData) {
        const dateData = {};
        filteredData.forEach(item => {
          const date = new Date(item.dateOpened).toLocaleDateString();
          dateData[date] = (dateData[date] || 0) + 1;
        });

        const sortedDates = Object.keys(dateData).sort((a, b) => new Date(a) - new Date(b));

        const ctx = document.getElementById('trendChart').getContext('2d');
        if (trendChart) trendChart.destroy();
        trendChart = new Chart(ctx, {
          type: 'line',
          data: {
            labels: sortedDates,
            datasets: [{
              label: 'Workflows Created',
              data: sortedDates.map(d => dateData[d]),
              borderColor: '#ffa726',
              backgroundColor: 'rgba(255, 167, 38, 0.1)',
              tension: 0.4
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: false
              }
            },
            scales: {
              y: {
                beginAtZero: true
              }
            }
          }
        });
      }

      /**
       * Update tracker table
       */
      function updateTable(filteredData) {
        if (filteredData.length === 0) {
          document.getElementById('tableContainer').innerHTML = '<div class="no-data"><p>No workflows found matching your filters.</p></div>';
          return;
        }

        let tableHTML = `
          <table class="tracker-table">
            <thead>
              <tr>
                <th>Request ID</th>
                <th>Workflow Type</th>
                <th>Employee Name</th>
                <th>Requestor</th>
                <th>Site</th>
                <th>Status</th>
                <th>Date Opened</th>
                <th>Date Completed</th>
                <th>Days</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
        `;

        filteredData.forEach(item => {
          const statusClass = 'status-' + item.status.toLowerCase().replace(' ', '-');
          const dateOpened = new Date(item.dateOpened).toLocaleDateString();
          const dateCompleted = item.dateCompleted ? new Date(item.dateCompleted).toLocaleDateString() : '-';
          const days = item.daysToComplete || '-';

          tableHTML += `
            <tr>
              <td><strong>${item.requestId}</strong></td>
              <td>${item.workflowType}</td>
              <td>${item.employeeName}</td>
              <td>${item.requestorName}</td>
              <td>${item.site}</td>
              <td><span class="status-badge ${statusClass}">${item.status}</span></td>
              <td>${dateOpened}</td>
              <td>${dateCompleted}</td>
              <td>${days}</td>
              <td>
                <div class="action-buttons">
                  <button class="btn-secondary" onclick="viewDetails('${item.requestId}', '${item.workflowType}')">View</button>
                  <button class="btn-secondary" onclick="editWorkflow('${item.requestId}', '${item.workflowType}')">Edit</button>
                  <button class="btn-warning" onclick="delayWorkflow('${item.requestId}', '${item.workflowType}')">Delay</button>
                  <button class="btn-danger" onclick="cancelWorkflow('${item.requestId}', '${item.workflowType}')">Cancel</button>
                </div>
              </td>
            </tr>
          `;
        });

        tableHTML += `
            </tbody>
          </table>
        `;

        document.getElementById('tableContainer').innerHTML = tableHTML;
      }

      /**
       * Action handlers
       */
      function viewDetails(requestId, workflowType) {
        const url = window.location.href.split('?')[0] + '?form=' + workflowType.toLowerCase().replace(/ /g, '_') + '&id=' + requestId;
        window.open(url, '_blank');
      }

      function editWorkflow(requestId, workflowType) {
        currentRequestId = requestId;
        currentWorkflowType = workflowType;
        document.getElementById('editNotes').value = '';
        openModal('editModal');
      }

      function confirmEdit() {
        const notes = document.getElementById('editNotes').value;
        closeModal('editModal');
        showStatus('success', 'Workflow reopened for editing. Redirecting...');
        setTimeout(() => {
          const url = window.location.href.split('?')[0] + '?form=' + currentWorkflowType.toLowerCase().replace(/ /g, '_') + '&id=' + currentRequestId + '&edit=true&notes=' + encodeURIComponent(notes);
          window.open(url, '_blank');
        }, 1500);
      }

      function delayWorkflow(requestId, workflowType) {
        currentRequestId = requestId;
        currentWorkflowType = workflowType;
        document.getElementById('delayUntil').value = '';
        document.getElementById('delayReason').value = '';
        openModal('delayModal');
      }

      function confirmDelay() {
        const delayDate = document.getElementById('delayUntil').value;
        const reason = document.getElementById('delayReason').value;

        if (!delayDate) {
          showStatus('error', 'Please select a new deadline date');
          return;
        }

        closeModal('delayModal');
        showStatus('success', 'Workflow delayed until ' + new Date(delayDate).toLocaleDateString());

        // Call server function
        google.script.run
          .withSuccessHandler(function(response) {
            if (response.success) {
              showStatus('success', response.message);
              setTimeout(() => applyFilters(), 1500);
            } else {
              showStatus('error', response.message);
            }
          })
          .processWorkflowAction(currentRequestId, currentWorkflowType, 'delay', {delayUntil: delayDate, reason: reason});
      }

      function cancelWorkflow(requestId, workflowType) {
        currentRequestId = requestId;
        currentWorkflowType = workflowType;
        document.getElementById('cancelReason').value = '';
        openModal('cancelModal');
      }

      function confirmCancel() {
        const reason = document.getElementById('cancelReason').value;
        closeModal('cancelModal');
        showStatus('success', 'Workflow cancelled');

        // Call server function
        google.script.run
          .withSuccessHandler(function(response) {
            if (response.success) {
              showStatus('success', response.message);
              setTimeout(() => applyFilters(), 1500);
            } else {
              showStatus('error', response.message);
            }
          })
          .processWorkflowAction(currentRequestId, currentWorkflowType, 'cancel', {reason: reason});
      }

      /**
       * Modal helpers
       */
      function openModal(modalId) {
        document.getElementById(modalId).classList.add('show');
      }

      function closeModal(modalId) {
        document.getElementById(modalId).classList.remove('show');
      }

      /**
       * Status message
       */
      function showStatus(type, message) {
        const statusEl = document.getElementById('statusMessage');
        statusEl.className = 'status-message show status-' + type;
        statusEl.textContent = message;
        setTimeout(() => {
          if (type === 'success') {
            statusEl.classList.remove('show');
          }
        }, 4000);
      }

      /**
       * Export tracker data
       */
      function exportData() {
        const filteredData = filterTrackerData(currentFilters, allTrackerData);
        let csv = 'Request ID,Workflow Type,Employee Name,Requestor,Site,Department,Position,Status,Date Opened,Date Completed,Days to Complete,Assigned To,Notes\n';

        filteredData.forEach(item => {
          const dateOpened = new Date(item.dateOpened).toLocaleDateString();
          const dateCompleted = item.dateCompleted ? new Date(item.dateCompleted).toLocaleDateString() : '';
          csv += `"${item.requestId}","${item.workflowType}","${item.employeeName}","${item.requestorName}","${item.site}","${item.department}","${item.position}","${item.status}","${dateOpened}","${dateCompleted}",${item.daysToComplete || ''},"${item.assignedTo}","${item.notes}"\n`;
        });

        const blob = new Blob([csv], {type: 'text/csv'});
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'workflow-tracker-' + new Date().toISOString().split('T')[0] + '.csv';
        a.click();
        window.URL.revokeObjectURL(url);
      }
    </script>

  </body>
</html>
