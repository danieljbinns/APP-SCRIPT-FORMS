<!DOCTYPE html>
<html>

<head>
  <base target="_top">
  <?!= HtmlService.createHtmlOutputFromFile('CSS.html').getContent(); ?>
</head>

<body>
  <div class="container">
    <div style="text-align: center; margin-bottom: 20px;">
      <img src="<?= logoUrl ?>" alt="Company Logo" style="max-height: 70px;">
    </div>
    <div id="form-container">
      <h1>
        <?= formTitle ?>
      </h1>

      <? if (typeof isStandalone !== 'undefined' && isStandalone) { ?>
      <p>Please provide the employee details below and confirm completion.</p>
      <hr>

      <h3>Employee Information</h3>
      <div class="question-wrapper">
        <label>First Name</label>
        <input type="text" name="First Name" required>
      </div>
      <div class="question-wrapper">
        <label>Last Name</label>
        <input type="text" name="Last Name" required>
      </div>
      <div class="question-wrapper">
        <label>Email Address</label>
        <input type="email" name="Requester Email" required>
      </div>
      <div class="question-wrapper">
        <label>Department</label>
        <input type="text" name="Department" required>
      </div>
      <div class="question-wrapper">
        <label>Reporting Manager</label>
        <input type="text" name="Reporting Manager" required>
      </div>
      <hr>
      <? } else { ?>
      <h3>Request for:
        <?= employeeName ?> (Temporary ID:
        <?= employeeId ?>)
      </h3>
      <p>Please confirm once the setup for this item has been completed.</p>
      <hr>
      <? } ?>

      <form id="parallel-task-form">
        <? if (typeof isStandalone !== 'undefined' && isStandalone) { ?>
        <input type="hidden" name="formType" value="<?= formType ?>">
        <input type="hidden" name="formTitle" value="<?= formTitle ?>">
        <input type="hidden" name="isStandalone" value="true">
        <? } else { ?>
        <input type="hidden" name="formType" value="parallel_task_submission">
        <input type="hidden" name="requestId" value="<?= requestId ?>">
        <? } ?>
        <input type="hidden" name="statusColumn" value="<?= statusColumn ?>">

        <div class="question-wrapper" style="display: flex; align-items: center; gap: 15px;">
          <input type="checkbox" id="isComplete" name="isComplete" style="width: 20px; height: 20px;" required>
          <label for="isComplete" style="margin: 0; font-size: 1.2em;">Has this setup been completed?</label>
        </div>

        <div id="submit-container">
          <button type="submit">Submit Confirmation</button>
        </div>
      </form>
    </div>
    <div id="status-message"></div>
  </div>

  <script>
    // Adds an event listener to the form that triggers when the 'submit' event occurs (i.e., the submit button is clicked).
    document.getElementById('parallel-task-form').addEventListener('submit', function (e) {
      // Prevents the default form submission behavior, which would cause the page to reload. We handle submission with JavaScript.
      e.preventDefault();
      // Get a reference to the form element that triggered the event.
      const form = e.target;
      // Provide immediate feedback to the user that the form is being processed.
      form.querySelector('button[type="submit"]').textContent = 'Submitting...';
      // Disable the button to prevent multiple submissions while the current one is in progress.
      form.querySelector('button[type="submit"]').disabled = true;

      // Create an object to hold the form data that will be sent to the server-side Google Apps Script function.
      const formData = {
        formType: form.formType.value,
        statusColumn: form.statusColumn.value,
        // **MODIFIED:** Now sends 'statusValue' for the generic handler
        // Ternary operator checks if the 'isComplete' checkbox is checked.
        // If it is, set 'statusValue' to 'Complete'; otherwise, set it to 'Incomplete'.
        statusValue: form.isComplete.checked ? 'Complete' : 'Incomplete'
      };

      // Add conditional fields based on standalone mode
      const isStandalone = form.isStandalone && form.isStandalone.value === 'true';
      if (isStandalone) {
        formData.formTitle = form.formTitle.value;
        formData.isStandalone = 'true';
        formData['First Name'] = form['First Name'].value;
        formData['Last Name'] = form['Last Name'].value;
        formData['Requester Email'] = form['Requester Email'].value;
        formData['Department'] = form['Department'].value;
        formData['Reporting Manager'] = form['Reporting Manager'].value;
      } else {
        formData.requestId = form.requestId.value;
      }

      const handlerFunction = isStandalone ? 'handleStandaloneSubmission' : 'handleParallelTaskSubmission';

      // This is the core of client-server communication in Google Apps Script.
      // It calls a server-side function from the client-side JavaScript.
      google.script.run
        // Defines a function to run if the server-side call is successful.
        .withSuccessHandler(function (response) {
          // On success, replace the form content with a confirmation message.
          let message = isStandalone
            ? `<h1>Request Submitted</h1><p>Your request has been submitted successfully.</p><p>Request ID: <strong>${response.requestId || 'N/A'}</strong></p><p>You may now close this window.</p>`
            : `<h1>Confirmation Received</h1><p>Thank you, the status has been updated. You may now close this window.</p>`;
          document.getElementById('form-container').innerHTML = message;
        })
        // Defines a function to run if the server-side call fails.
        .withFailureHandler(function (error) {
          // On failure, get the status message element to display the error.
          const statusMessage = document.getElementById('status-message');
          statusMessage.className = 'status-error'; // Apply error styling.
          statusMessage.textContent = 'Error: ' + error.message; // Show the error message.
          // Re-enable the form for another attempt.
          form.querySelector('button[type="submit"]').textContent = 'Submit Confirmation';
          form.querySelector('button[type="submit"]').disabled = false;
        })[handlerFunction](formData);
    });
  </script>
</body>

</html>