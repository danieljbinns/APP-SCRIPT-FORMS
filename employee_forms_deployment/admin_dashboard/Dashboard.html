<!DOCTYPE html>
<html>

<head>
    <base target="_top">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Employee Request Dashboard</title>
    <style>
        :root {
            --bg-color: #000000;
            --card-bg: #1a1a1a;
            --text-main: #ffffff;
            --text-muted: #b0b0b0;
            --brand-red: #EB1C2D;
            --brand-red-hover: #c41522;
            --input-bg: #2a2a2a;
            --input-border: #444;
            --border-color: #333;
            --status-complete: #0f9d58;
            --status-open: #f4b400;
            --status-progress: #4285f4;
            --status-overdue: #db4437;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        .header-main {
            background: var(--card-bg);
            padding: 2rem;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            margin-bottom: 30px;
            border-left: 5px solid var(--brand-red);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-info h1 {
            font-size: 1.8rem;
            margin-bottom: 5px;
        }

        .header-info p {
            color: var(--text-muted);
        }

        .logo {
            max-height: 50px;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--card-bg);
            padding: 1.5rem;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            text-align: center;
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            color: var(--text-muted);
            font-size: 0.9rem;
            text-transform: uppercase;
        }

        .stat-card.total .stat-number {
            color: var(--brand-red);
        }

        .stat-card.open .stat-number {
            color: var(--status-open);
        }

        .stat-card.progress .stat-number {
            color: var(--status-progress);
        }

        .stat-card.complete .stat-number {
            color: var(--status-complete);
        }

        /* Filters */
        .filters-section {
            background: var(--card-bg);
            padding: 1.5rem;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            margin-bottom: 30px;
        }

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .filter-field {
            display: flex;
            flex-direction: column;
        }

        .filter-field label {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-bottom: 8px;
            font-weight: 600;
        }

        input,
        select {
            padding: 10px;
            background: var(--input-bg);
            border: 1px solid var(--input-border);
            color: white;
            border-radius: 6px;
            font-size: 1rem;
        }

        /* Table */
        .table-container {
            background: var(--card-bg);
            border-radius: 8px;
            border: 1px solid var(--border-color);
            overflow: hidden;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            text-align: left;
            background: rgba(255, 255, 255, 0.03);
            color: var(--text-muted);
            font-size: 0.8rem;
            text-transform: uppercase;
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
        }

        td {
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
            vertical-align: middle;
        }

        tr:hover {
            background: rgba(255, 255, 255, 0.02);
        }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: bold;
        }

        .status-complete {
            background: rgba(15, 157, 88, 0.2);
            color: #0f9d58;
            border: 1px solid #0f9d58;
        }

        .status-pending {
            background: rgba(244, 180, 0, 0.2);
            color: #f4b400;
            border: 1px solid #f4b400;
        }

        .emp-name {
            font-weight: bold;
            color: white;
            display: block;
            font-size: 1.05rem;
        }

        .emp-meta {
            color: var(--text-muted);
            font-size: 0.85rem;
        }

        .btn-view {
            background: var(--brand-red);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            text-decoration: none;
            display: inline-block;
            font-size: 0.85rem;
        }

        .btn-view:hover {
            background: var(--brand-red-hover);
        }

        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            display: none;
        }

        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-left-color: var(--brand-red);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body>
    <div id="loading-overlay">
        <div class="spinner"></div>
    </div>

    <div class="container">
        <div class="header-main">
            <div class="header-info">
                <h1>Employee Request Dashboard</h1>
                <p>Global view of all employee requests and workflow statuses</p>
            </div>
            <img src="https://team-signature-logos.s3.us-east-1.amazonaws.com/Team+Logo+Black+Background.png"
                class="logo">
        </div>

        <!-- Stats -->
        <div class="stats-grid">
            <div class="stat-card total">
                <div class="stat-number" id="stat-total">0</div>
                <div class="stat-label">Total Requests</div>
            </div>
            <div class="stat-card open">
                <div class="stat-number" id="stat-open">0</div>
                <div class="stat-label">Pending HR</div>
            </div>
            <div class="stat-card progress">
                <div class="stat-number" id="stat-progress">0</div>
                <div class="stat-label">In IT Setup</div>
            </div>
            <div class="stat-card complete">
                <div class="stat-number" id="stat-complete">0</div>
                <div class="stat-label">IT Complete</div>
            </div>
        </div>

        <!-- Filters -->
        <div class="filters-section">
            <div class="filters-grid">
                <div class="filter-field">
                    <label>Search Employees</label>
                    <input type="text" id="searchInput" placeholder="Search by name, site, or ID..."
                        onkeyup="filterTable()">
                </div>
                <div class="filter-field">
                    <label>Status</label>
                    <select id="statusFilter" onchange="filterTable()">
                        <option value="all">All Statuses</option>
                        <option value="pending-hr">Pending HR</option>
                        <option value="in-it">In IT Setup</option>
                        <option value="complete">IT Complete</option>
                    </select>
                </div>
                <div class="filter-field">
                    <label>&nbsp;</label>
                    <button onclick="loadData()" class="btn-view" style="padding: 12px; height: 45px;">ðŸ”„ Refresh
                        Data</button>
                </div>
            </div>
        </div>

        <!-- Main Table -->
        <div class="table-container">
            <table id="requestTable">
                <thead>
                    <tr>
                        <th>Employee & Position</th>
                        <th>Submitted</th>
                        <th>Last Activity</th>
                        <th>Staff Member</th>
                        <th>HR/IT Status</th>
                        <th>Specialists</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    <!-- Populated dynamically -->
                </tbody>
            </table>
            <div id="emptyMsg" style="text-align:center; padding: 40px; color: var(--text-muted); display: none;">
                No requests found matching your filters.
            </div>
        </div>
    </div>

    <script>
        let allData = [];

        function loadData() {
            showLoading(true);
            console.log('Loading dashboard data...');
            google.script.run
                .withSuccessHandler(res => {
                    showLoading(false);
                    console.log('Dashboard response received:', res);
                    if (res && res.success) {
                        allData = res.data;
                        updateStats(res.stats);
                        renderTable(allData);
                    } else {
                        const msg = res ? res.message : 'Server returned null (possible timeout or quota issue)';
                        console.error('Data loading error:', msg);
                        alert('Error loading data: ' + msg);
                    }
                })
                .withFailureHandler(err => {
                    showLoading(false);
                    console.error('Google Script system error:', err);
                    alert('System Error: ' + err.message);
                })
                .getDashboardData();
        }

        function updateStats(stats) {
            document.getElementById('stat-total').innerText = stats.total;
            document.getElementById('stat-open').innerText = stats.open;
            document.getElementById('stat-progress').innerText = stats.progress;
            document.getElementById('stat-complete').innerText = stats.complete;
        }

        function renderTable(data) {
            const tbody = document.getElementById('tableBody');
            const emptyMsg = document.getElementById('emptyMsg');
            tbody.innerHTML = '';

            if (data.length === 0) {
                emptyMsg.style.display = 'block';
                return;
            }
            emptyMsg.style.display = 'none';

            data.forEach(row => {
                const tr = document.createElement('tr');

                // Define status classes
                const hrCls = row.status.hr === 'Complete' ? 'status-complete' : 'status-pending';
                const itCls = row.status.it === 'Complete' ? 'status-complete' : 'status-pending';

                // Format Specialists
                const specSummary = row.status.specialists === 'Pending' ?
                    '<span class="status-badge status-pending">PENDING</span>' :
                    '<span class="status-badge status-complete">[DONE] ' + row.status.specialists + '</span>';

                tr.innerHTML = '<td>' +
                    '<span class="emp-name">' + row.employee + '</span>' +
                    '<span class="emp-meta">' + row.position + ' | ' + row.site + '</span>' +
                    '</td>' +
                    '<td class="emp-meta" style="font-size: 0.8rem;">' + formatDateTime(row.submissionTime) + '</td>' +
                    '<td class="emp-meta" style="font-size: 0.8rem;">' + (row.completion.time ? formatDateTime(row.completion.time) : '<span style="color:#666">Pending</span>') + '</td>' +
                    '<td class="emp-meta" style="font-size: 0.8rem;">' + (row.completion.handler || 'N/A') + '</td>' +
                    '<td>' +
                    '<div style="margin-bottom:4px"><span class="status-badge ' + hrCls + '">' + row.status.hr.toUpperCase() + ' HR</span></div>' +
                    '<div><span class="status-badge ' + itCls + '">' + row.status.it.toUpperCase() + ' IT</span></div>' +
                    '</td>' +
                    '<td>' + specSummary + '</td>' +
                    '<td>' +
                    '<a href="' + getDetailsUrl(row.id) + '" target="_top" class="btn-view">View Details</a>' +
                    '</td>';
                tbody.appendChild(tr);
            });
        }

        function getDetailsUrl(id) {
            const baseUrl = '<?!= scriptUrl ?>';
            return baseUrl + '?view=details&id=' + id;
        }

        function filterTable() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const status = document.getElementById('statusFilter').value;

            const filtered = allData.filter(row => {
                const matchesSearch = row.employee.toLowerCase().includes(search) ||
                    row.id.toLowerCase().includes(search) ||
                    row.site.toLowerCase().includes(search);

                let matchesStatus = true;
                if (status === 'pending-hr') matchesStatus = row.status.hr === 'Pending';
                if (status === 'in-it') matchesStatus = row.status.hr === 'Complete' && row.status.it === 'Pending';
                if (status === 'complete') matchesStatus = row.status.it === 'Complete';

                return matchesSearch && matchesStatus;
            });

            renderTable(filtered);
        }

        function showLoading(show) {
            document.getElementById('loading-overlay').style.display = show ? 'flex' : 'none';
        }

        function formatDateTime(dateString) {
            if (!dateString) return 'N/A';
            const d = new Date(dateString);
            return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) + ' ' +
                d.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
        }

        window.onload = loadData;
    </script>
</body>

</html>